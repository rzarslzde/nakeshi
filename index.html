<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Service Countdown</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

  <style>
    :root {
      --camo-1:#0f1b12; --camo-2:#1b2a1b; --camo-3:#2b3e2b; --camo-4:#3f5a3a;
      --accent:#9AE6B4;
    }
    body { background: radial-gradient(circle at 20% 10%, var(--camo-3), var(--camo-1) 60%) fixed; }
    .panel {
      background:
        radial-gradient(120px 80px at 20% 30%, rgba(255,255,255,.03), transparent 70%),
        radial-gradient(100px 60px at 80% 70%, rgba(255,255,255,.02), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.08);
    }
    .title { font-family: "Black Ops One", system-ui, sans-serif; letter-spacing: .02em; }
    .tick { transition: transform .2s ease, opacity .2s ease; will-change: transform, opacity; }
    .tick-enter { transform: translateY(8px); opacity: 0; }
    .tick-show  { transform: translateY(0);   opacity: 1; }
    .mono { font-variant-numeric: tabular-nums; }
    .badge { background: rgba(154,230,180,.12); border: 1px solid rgba(154,230,180,.25); }
    .bar { height: 10px; border-radius: 999px; background: rgba(255,255,255,.08); overflow: hidden; }
    .bar>span { display:block; height:100%; background: linear-gradient(90deg,#86efac,#4ade80); }

    /* Tiny timer styles */
    .mini-panel {
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.12);
    }
    .mini-heat {
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow: hidden;
    }
    .mini-heat > span {
      display:block;
      height:100%;
      width:0%;
      /* color will be controlled via inline style (hsl) */
      background: currentColor;
    }
    .confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 60;
    }
  </style>
</head>
<body class="h-full text-white">
  <!-- Tiny Daily Timer (top-left) -->
  <aside class="fixed top-3 left-3 z-50 text-[11px] sm:text-xs">
    <div class="mini-panel rounded-lg px-3 py-2 shadow-lg">
      <div class="flex items-center gap-2">
        <span class="opacity-80">üïí Daily Timer</span>
        <button id="miniUseNow"
                class="ml-auto px-2 py-0.5 rounded bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-400/30">
          Use current time (+9h)
        </button>
        <button id="miniToggleEdit"
                class="px-2 py-0.5 rounded bg-white/10 hover:bg-white/15 border border-white/15">
          Edit
        </button>
      </div>

      <div class="mt-1 mono">
        <div class="flex items-center gap-2">
          <span class="opacity-70">Remaining:</span>
          <span id="miniRemaining" class="font-semibold">‚Äî</span>
        </div>
        <div class="mt-1 mini-heat" title="Progress">
          <span id="miniHeatFill" style="color:hsl(0 90% 55%); width:0%"></span>
        </div>
        <div class="mt-1 flex items-center justify-between opacity-70">
          <span id="miniStartInfo">Start: ‚Äî</span>
          <span id="miniEndInfo">End: ‚Äî</span>
        </div>
      </div>

      <!-- Edit panel -->
      <form id="miniEdit" class="hidden mt-2 grid grid-cols-1 gap-2">
        <div class="grid grid-cols-2 gap-2">
          <label class="flex flex-col">
            <span class="opacity-70 mb-1">Start</span>
            <input id="miniStartInput" type="datetime-local"
                   class="px-2 py-1 rounded bg-white/10 border border-white/15 focus:outline-none"
                   />
          </label>
          <label class="flex flex-col">
            <span class="opacity-70 mb-1">Duration (hours)</span>
            <input id="miniDurInput" type="number" step="0.25" min="0" value="9"
                   class="px-2 py-1 rounded bg-white/10 border border-white/15 focus:outline-none"
                   />
          </label>
        </div>
        <div class="grid grid-cols-1">
          <label class="flex flex-col">
            <span class="opacity-70 mb-1">‚Ä¶or set End time</span>
            <input id="miniEndInput" type="datetime-local"
                   class="px-2 py-1 rounded bg-white/10 border border-white/15 focus:outline-none"
                   />
          </label>
        </div>
        <div class="flex items-center justify-end gap-2">
          <button type="button" id="miniClear"
                  class="px-2 py-1 rounded bg-white/10 hover:bg-white/15 border border-white/15">
            Clear
          </button>
          <button type="submit"
                  class="px-2 py-1 rounded bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-400/30">
            Start
          </button>
        </div>
      </form>
    </div>
  </aside>

  <main class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-3xl">
      <!-- Header -->
      <header class="mb-8 text-center">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full badge">
          <span class="text-sm text-emerald-200">ü™ñ Soldier‚Äôs Countdown</span>
        </div>
        <h1 id="title" class="title mt-4 text-3xl sm:text-4xl">
          D-Day: End of Service
        </h1>
        <p class="mt-2 text-sm text-emerald-200/70">Reading <code class="text-emerald-200">end-date.json</code> from this repository</p>
      </header>

      <!-- Card -->
      <section class="panel rounded-2xl p-6 sm:p-10 shadow-2xl">
        <p id="countdown"
           class="mono text-xl sm:text-2xl leading-relaxed font-semibold text-center text-emerald-100">
           Loading‚Ä¶
        </p>

        <!-- Milestones -->
        <div class="mt-8 grid grid-cols-2 gap-4">
          <div class="rounded-xl p-4 bg-white/5 ring-1 ring-white/10 text-center">
            <div class="text-xs text-emerald-200/80 tracking-wider">TOTAL DAYS</div>
            <div id="daysTotal" class="mt-1 text-2xl font-bold mono">‚Äî</div>
            <div class="text-[11px] text-emerald-200/60">remaining</div>
          </div>
          <div class="rounded-xl p-4 bg-white/5 ring-1 ring-white/10 text-center">
            <div class="text-xs text-emerald-200/80 tracking-wider">TOTAL HOURS</div>
            <div id="hoursTotal" class="mt-1 text-2xl font-bold mono">‚Äî</div>
            <div class="text-[11px] text-emerald-200/60">to go</div>
          </div>
        </div>

        <!-- Progress -->
        <div id="progressWrap" class="mt-8 hidden">
          <div class="flex items-center justify-between text-sm text-emerald-200/80 mb-2">
            <span>Service Progress</span>
            <span id="progressPct" class="mono">0%</span>
          </div>
          <div class="bar"><span id="progressBar" style="width:0%"></span></div>
          <p id="startEndInfo" class="mt-2 text-xs text-emerald-200/60 mono"></p>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-emerald-200/70 text-sm">
          <span>‚è±Ô∏è Updates every second ‚Äî </span>
          <span id="endInfo" class="mono"></span>
        </div>
      </section>
    </div>
  </main>

  <script>
    (function () {
      const { DateTime } = luxon;

      const elTitle   = document.getElementById('title');
      const elCd      = document.getElementById('countdown');
      const elDays    = document.getElementById('daysTotal');
      const elHours   = document.getElementById('hoursTotal');
      const elEndInfo = document.getElementById('endInfo');
      const wrapProg  = document.getElementById('progressWrap');
      const bar       = document.getElementById('progressBar');
      const pct       = document.getElementById('progressPct');
      const startEnd  = document.getElementById('startEndInfo');

      let endAt = null, startAt = null;

      function fmt(parts) {
        return `${parts.years} years, ${parts.months} months, ${parts.days} days, ` +
               `${parts.hours} hours, ${parts.minutes} minutes and ${parts.seconds} seconds`;
      }

      function calcFutureDiff(now, end) {
        const dur = now.until(end)
          .toDuration(['years','months','days','hours','minutes','seconds'])
          .shiftTo('years','months','days','hours','minutes','seconds');
        return {
          years: Math.max(0, Math.floor(dur.years ?? 0)),
          months: Math.max(0, Math.floor(dur.months ?? 0)),
          days: Math.max(0, Math.floor(dur.days ?? 0)),
          hours: Math.max(0, Math.floor(dur.hours ?? 0)),
          minutes: Math.max(0, Math.floor(dur.minutes ?? 0)),
          seconds: Math.max(0, Math.floor(dur.seconds ?? 0))
        };
      }

      function updateProgress(now){
        if (!startAt || !endAt) return;
        const total = endAt.diff(startAt).as('seconds');
        const passed = now.diff(startAt).as('seconds');
        const ratio = Math.min(1, Math.max(0, passed / total));
        const percent = (ratio * 100).toFixed(2);
        bar.style.width = percent + '%';
        pct.textContent = percent + '%';
        startEnd.textContent = `Start: ${startAt.toISO({ suppressMilliseconds:true })}  |  End: ${endAt.toISO({ suppressMilliseconds:true })}`;
      }

      function tick() {
        if (!endAt) return;
        const now = DateTime.now();

        if (now >= endAt) {
          elCd.textContent = 'üéñÔ∏è Mission complete. Discharge achieved.';
          elDays.textContent  = '0';
          elHours.textContent = '0';
          updateProgress(now);
          return;
        }

        const parts = calcFutureDiff(now, endAt);
        elCd.classList.add('tick','tick-enter');
        requestAnimationFrame(() => {
          elCd.textContent = `Remaining: ${fmt(parts)}`;
          elCd.classList.remove('tick-enter');
          elCd.classList.add('tick-show');
          setTimeout(() => elCd.classList.remove('tick','tick-show'), 150);
        });

        elDays.textContent  = Math.max(0, Math.floor(endAt.diff(now, 'days').days)).toLocaleString();
        elHours.textContent = Math.max(0, Math.floor(endAt.diff(now, 'hours').hours)).toLocaleString();
        updateProgress(now);
      }

      async function loadConfig() {
        try {
          const res = await fetch('./end-date.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('Cannot read end-date.json');
          const json = await res.json();
          if (!json.end) throw new Error('Missing "end" field in end-date.json');

          endAt = DateTime.fromISO(json.end, { setZone: true });
          if (!endAt.isValid) throw new Error('Invalid ISO date in "end"');

          if (json.start) {
            startAt = DateTime.fromISO(json.start, { setZone: true });
            if (startAt.isValid) wrapProg.classList.remove('hidden');
          }

          if (json.title) elTitle.textContent = json.title;
          elEndInfo.textContent = `Target: ${endAt.toISO({ suppressMilliseconds:true })}`;

          tick();
          setInterval(tick, 1000);
        } catch (err) {
          console.error(err);
          elCd.textContent = 'Error: could not load end-date.json. Make sure the file exists.';
        }
      }

      loadConfig();
    })();

    /* ---------------------------
       Tiny Daily Timer (top-left)
       --------------------------- */
    (function() {
      const { DateTime, Duration } = luxon;
      const $ = (id) => document.getElementById(id);

      const useNowBtn   = $('miniUseNow');
      const toggleEdit  = $('miniToggleEdit');
      const editForm    = $('miniEdit');
      const startInput  = $('miniStartInput');
      const durInput    = $('miniDurInput');
      const endInput    = $('miniEndInput');
      const clearBtn    = $('miniClear');

      const remainingEl = $('miniRemaining');
      const heatFill    = $('miniHeatFill');
      const startInfo   = $('miniStartInfo');
      const endInfo     = $('miniEndInfo');

      let miniStart = null;
      let miniEnd   = null;
      let finished  = false;

      function hslFromRatio(r) {
        // r: 0 (start, red) -> 1 (end, green)
        const hue = Math.max(0, Math.min(120, Math.round(r * 120)));
        return `hsl(${hue} 90% 55%)`;
      }

      function fmtHHMMSS(dur) {
        const s = Math.max(0, Math.floor(dur.as('seconds')));
        const hh = String(Math.floor(s / 3600)).padStart(2,'0');
        const mm = String(Math.floor((s % 3600) / 60)).padStart(2,'0');
        const ss = String(s % 60).padStart(2,'0');
        return `${hh}:${mm}:${ss}`;
      }

      function updateMini() {
        if (!miniStart || !miniEnd) {
          remainingEl.textContent = '‚Äî';
          heatFill.style.width = '0%';
          heatFill.style.color = hslFromRatio(0);
          startInfo.textContent = 'Start: ‚Äî';
          endInfo.textContent = 'End: ‚Äî';
          return;
        }

        const now = DateTime.now();

        const total = miniEnd.diff(miniStart, 'seconds').seconds;
        const passed = now.diff(miniStart, 'seconds').seconds;
        const ratio = Math.max(0, Math.min(1, total > 0 ? (passed / total) : 1));
        const remaining = miniEnd.diff(now);
        const remainingSec = remaining.as('seconds');

        // Heat color + width
        heatFill.style.color = hslFromRatio(ratio);
        heatFill.style.width = (ratio * 100).toFixed(2) + '%';

        // Labels
        startInfo.textContent = `Start: ${miniStart.toFormat("yyyy-LL-dd HH:mm")}`;
        endInfo.textContent   = `End: ${miniEnd.toFormat("yyyy-LL-dd HH:mm")}`;

        if (remainingSec <= 0) {
          remainingEl.textContent = '00:00:00';
          if (!finished) {
            finished = true;
            celebrate();
          }
          return;
        }

        finished = false;
        remainingEl.textContent = fmtHHMMSS(remaining.shiftTo('seconds'));
      }

      // Confetti celebration (emoji burst)
      function celebrate() {
        const layer = document.createElement('div');
        layer.className = 'confetti';
        document.body.appendChild(layer);

        const W = window.innerWidth;
        const H = window.innerHeight;
        const count = 120;
        const emojis = ['üéâ','üéä','‚ú®','üü©','üü•','üü®','‚≠ê'];

        const pieces = [];
        for (let i=0;i<count;i++){
          const span = document.createElement('span');
          span.textContent = emojis[Math.floor(Math.random()*emojis.length)];
          span.style.position = 'absolute';
          span.style.left = (Math.random()*W) + 'px';
          span.style.top  = (-20 - Math.random()*100) + 'px';
          span.style.fontSize = (12 + Math.random()*20) + 'px';
          span.style.transform = `rotate(${Math.random()*360}deg)`;
          layer.appendChild(span);
          pieces.push({
            el: span,
            x: parseFloat(span.style.left),
            y: parseFloat(span.style.top),
            vy: 2 + Math.random()*4,
            vx: -2 + Math.random()*4,
            rot: Math.random()*360,
            vr: -4 + Math.random()*8,
            life: 0,
            lifeMax: 180 + Math.random()*120
          });
        }

        let raf;
        function step(){
          for (const p of pieces){
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.05; // gravity
            p.rot += p.vr;
            p.life++;
            p.el.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.rot}deg)`;
            p.el.style.opacity = String(Math.max(0, 1 - p.life / p.lifeMax));
          }
          if (pieces.some(p => p.life < p.lifeMax && p.y < H+40)) {
            raf = requestAnimationFrame(step);
          } else {
            cancelAnimationFrame(raf);
            layer.remove();
          }
        }
        raf = requestAnimationFrame(step);
      }

      // Controls
      useNowBtn.addEventListener('click', () => {
        const now = DateTime.now();
        miniStart = now;
        miniEnd = now.plus({ hours: 9 });
        startInput.value = now.toFormat("yyyy-LL-dd'T'HH:mm");
        durInput.value = '9';
        endInput.value = miniEnd.toFormat("yyyy-LL-dd'T'HH:mm");
        finished = false;
        updateMini();
      });

      toggleEdit.addEventListener('click', () => {
        editForm.classList.toggle('hidden');
      });

      clearBtn.addEventListener('click', () => {
        miniStart = null;
        miniEnd   = null;
        startInput.value = '';
        durInput.value   = '9';
        endInput.value   = '';
        finished = false;
        updateMini();
      });

      editForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const startVal = startInput.value ? DateTime.fromISO(startInput.value) : DateTime.now();
        let endVal = endInput.value ? DateTime.fromISO(endInput.value) : null;
        const durVal = parseFloat(durInput.value || '9');

        if (!endVal || !endVal.isValid) {
          // compute end from start + duration
          endVal = startVal.plus(Duration.fromObject({ hours: isNaN(durVal) ? 9 : durVal }));
        }

        if (!startVal.isValid || !endVal.isValid) return;

        miniStart = startVal;
        miniEnd = endVal;
        finished = false;
        updateMini();
        editForm.classList.add('hidden');
      });

      // Tick
      updateMini();
      setInterval(updateMini, 1000);
    })();
  </script>
</body>
</html>
